<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Level 5 — Python in the Browser</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #1a1b26;
  --surface: #24283b;
  --border: #3b4261;
  --text: #c0caf5;
  --text-dim: #565f89;
  --accent: #7aa2f7;
  --green: #9ece6a;
  --yellow: #e0af68;
  --red: #f7768e;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

.container { max-width: 960px; margin: 0 auto; padding: 1.5rem; }

.header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;
}
.header h1 { font-size: 1.4rem; font-weight: 700; color: #fff; }

.nav-links { display: flex; gap: 0.75rem; font-size: 0.85rem; }
.nav-links a { color: var(--accent); text-decoration: none; }
.nav-links a:hover { text-decoration: underline; }

.description {
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
  padding: 1rem 1.25rem; margin-bottom: 1rem; font-size: 0.9rem;
  white-space: pre-wrap; color: var(--text-dim); max-height: 200px; overflow-y: auto;
}

.editor-wrapper {
  border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 0.75rem;
}

.CodeMirror {
  height: auto; min-height: 200px; max-height: 500px; font-size: 14px;
  font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
}

.toolbar { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }

.btn {
  padding: 0.5rem 1.25rem; border: none; border-radius: 6px;
  font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: opacity 0.15s;
}
.btn:hover { opacity: 0.85; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-run { background: var(--green); color: var(--bg); }
.btn-check { background: var(--accent); color: var(--bg); }
.btn-reset { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
.btn-clear { background: var(--surface); color: var(--text); border: 1px solid var(--border); }

.output-wrapper {
  background: #0d1117; border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
}
.output-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.5rem 1rem; background: var(--surface);
  border-bottom: 1px solid var(--border); font-size: 0.8rem; color: var(--text-dim);
}
.output-content {
  padding: 1rem; font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 13px; min-height: 100px; max-height: 300px; overflow-y: auto;
  white-space: pre-wrap; word-break: break-word;
}
.output-content .error { color: var(--red); }
.output-content .info { color: var(--text-dim); }

.loading-overlay {
  position: fixed; inset: 0; background: rgba(26, 27, 38, 0.9);
  display: flex; align-items: center; justify-content: center;
  z-index: 100; flex-direction: column; gap: 1rem;
}
.loading-overlay p { font-size: 1.1rem; color: var(--text); }
.spinner {
  width: 40px; height: 40px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.hidden { display: none; }

@media (max-width: 600px) {
  .container { padding: 1rem; }
  .header h1 { font-size: 1.1rem; }
  .CodeMirror { font-size: 13px; }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="spinner" role="status" aria-label="Loading Python runtime"></div>
  <p>Loading Python runtime...</p>
</div>

<div class="container" role="main">
  <div class="header">
    <h1 id="exerciseTitle">Exercise</h1>
    <nav class="nav-links" role="navigation" aria-label="Exercise navigation">
      <a href="#" id="prevLink">&larr; Prev</a>
      <a href="index.html">All Exercises</a>
      <a href="#" id="nextLink">Next &rarr;</a>
    </nav>
  </div>

  <div class="description" id="description"></div>

  <div class="editor-wrapper" aria-label="Python code editor">
    <textarea id="editor" aria-label="Python code editor"></textarea>
  </div>

  <div class="toolbar">
    <button class="btn btn-run" id="runBtn" disabled>Run (Ctrl+Enter)</button>
    <button class="btn btn-check" id="checkBtn" disabled>Check</button>
    <button class="btn btn-reset" id="resetBtn">Reset Code</button>
    <button class="btn btn-clear" id="clearBtn">Clear Output</button>
  </div>

  <div class="output-wrapper">
    <div class="output-header">
      <span>Output</span>
      <span id="statusLabel"></span>
    </div>
    <div class="output-content" id="output" role="log" aria-live="polite">
      <span class="info">Click "Run" to execute your code, or "Check" to validate.</span>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script>
var EXERCISES = {
  "1": {
    title: "Exercise 1 — Retry with Counter",
    description: "Write a function retry(func, max_attempts=3) that calls func() repeatedly\nuntil it succeeds (returns without raising an exception) or max_attempts is reached.\n\nReturn a dict:\n  {\"success\": True/False, \"result\": <return value or None>, \"attempts\": <count>}\n\nIf func raises an exception, catch it and try again.\nIf all attempts fail, return the last exception message as \"error\".\n\nAlso write make_flaky(fail_times) that returns a function which fails\nthe first fail_times calls (raises ValueError) then succeeds returning \"OK\".\n\nExamples:\n  f = make_flaky(2)  # fails twice, then succeeds\n  retry(f, 3)  -> {\"success\": True, \"result\": \"OK\", \"attempts\": 3}\n  retry(f, 1)  -> would fail since only 1 attempt allowed",
    code: 'def retry(func, max_attempts=3):\n    """Retry a function up to max_attempts times."""\n    # Your code here\n    pass\n\ndef make_flaky(fail_times):\n    """Create a function that fails fail_times then succeeds."""\n    # Your code here\n    pass\n\n\n# Try it out:\nf1 = make_flaky(2)\nresult = retry(f1, max_attempts=5)\nprint(f"Result: {result}")\n\nf2 = make_flaky(10)\nresult2 = retry(f2, max_attempts=3)\nprint(f"Result: {result2}")\n\n# Always succeeds\nresult3 = retry(lambda: 42, max_attempts=1)\nprint(f"Result: {result3}")\n',
    check: 'f1 = make_flaky(2)\nr1 = retry(f1, 5)\nassert r1["success"] == True, f"Should succeed, got {r1}"\nassert r1["result"] == "OK"\nassert r1["attempts"] == 3, f"Should take 3 attempts, got {r1[\'attempts\']}"\n\nf2 = make_flaky(10)\nr2 = retry(f2, 3)\nassert r2["success"] == False, f"Should fail, got {r2}"\nassert r2["attempts"] == 3\nassert "error" in r2\n\nr3 = retry(lambda: 42, 1)\nassert r3["success"] == True\nassert r3["result"] == 42\nassert r3["attempts"] == 1\nprint("All tests passed!")\n'
  },
  "2": {
    title: "Exercise 2 — Circuit Breaker",
    description: "Implement a simplified circuit breaker pattern.\n\nWrite functions that work with a circuit breaker state dict:\n\n1. create_breaker(threshold=3) — return a breaker state:\n   {\"state\": \"closed\", \"failure_count\": 0, \"threshold\": threshold, \"success_count\": 0}\n\n2. call_with_breaker(breaker, func)\n   - If state is \"open\", don't call func. Return {\"allowed\": False, \"state\": \"open\"}\n   - If state is \"closed\" or \"half-open\":\n     - Call func()\n     - On success: reset failure_count to 0, increment success_count.\n       If state was \"half-open\", move to \"closed\".\n       Return {\"allowed\": True, \"result\": <value>, \"state\": breaker[\"state\"]}\n     - On failure: increment failure_count.\n       If failure_count >= threshold, move to \"open\".\n       Return {\"allowed\": True, \"error\": str(e), \"state\": breaker[\"state\"]}\n\n3. reset_breaker(breaker) — set state to \"half-open\", keep counts\n\nExample:\n  b = create_breaker(threshold=2)\n  call_with_breaker(b, lambda: 1/0)  # fail 1\n  call_with_breaker(b, lambda: 1/0)  # fail 2 -> opens\n  call_with_breaker(b, lambda: 42)   # blocked, breaker is open",
    code: 'def create_breaker(threshold=3):\n    """Create a circuit breaker state dict."""\n    # Your code here\n    pass\n\ndef call_with_breaker(breaker, func):\n    """Call func through the circuit breaker."""\n    # Your code here\n    pass\n\ndef reset_breaker(breaker):\n    """Reset breaker to half-open state."""\n    # Your code here\n    pass\n\n\n# Try it out:\nb = create_breaker(threshold=2)\n\n# Two failures should trip the breaker\nprint(call_with_breaker(b, lambda: 1/0))\nprint(f"State after 1 fail: {b[\'state\']}")\n\nprint(call_with_breaker(b, lambda: 1/0))\nprint(f"State after 2 fails: {b[\'state\']}")\n\n# Should be blocked now\nprint(call_with_breaker(b, lambda: 42))\n\n# Reset to half-open and try again\nreset_breaker(b)\nprint(f"\\nState after reset: {b[\'state\']}")\nprint(call_with_breaker(b, lambda: "recovered!"))\nprint(f"State after success: {b[\'state\']}")\n',
    check: 'b = create_breaker(threshold=2)\nassert b["state"] == "closed"\nassert b["failure_count"] == 0\n\nr1 = call_with_breaker(b, lambda: 1/0)\nassert r1["allowed"] == True\nassert "error" in r1\nassert b["failure_count"] == 1\nassert b["state"] == "closed"\n\nr2 = call_with_breaker(b, lambda: 1/0)\nassert b["state"] == "open", f"Should be open after 2 fails, got {b[\'state\']}"\n\nr3 = call_with_breaker(b, lambda: 42)\nassert r3["allowed"] == False\nassert r3["state"] == "open"\n\nreset_breaker(b)\nassert b["state"] == "half-open"\n\nr4 = call_with_breaker(b, lambda: "ok")\nassert r4["allowed"] == True\nassert r4["result"] == "ok"\nassert b["state"] == "closed"\nprint("All tests passed!")\n'
  },
  "3": {
    title: "Exercise 3 — Priority Task Scheduler",
    description: "Build a simple priority-based task scheduler using a sorted list.\n\n1. create_scheduler() — return {\"tasks\": [], \"completed\": []}\n\n2. add_task(scheduler, name, priority)\n   - priority is an int (lower = higher priority, 1 is most urgent)\n   - Add {\"name\": name, \"priority\": priority, \"status\": \"pending\"}\n   - Keep tasks sorted by priority (lowest number first)\n\n3. run_next(scheduler)\n   - Remove and \"run\" the highest-priority task (lowest number)\n   - Move it to completed list with status \"done\"\n   - Return the task name, or None if no tasks\n\n4. get_pending(scheduler) — return list of pending task names in priority order\n\n5. get_stats(scheduler)\n   - Return {\"pending\": <count>, \"completed\": <count>, \"total\": <count>}\n\nExample:\n  s = create_scheduler()\n  add_task(s, \"deploy\", 1)\n  add_task(s, \"test\", 2)\n  add_task(s, \"docs\", 3)\n  run_next(s)  -> \"deploy\"\n  get_pending(s)  -> [\"test\", \"docs\"]",
    code: 'def create_scheduler():\n    """Create an empty task scheduler."""\n    # Your code here\n    pass\n\ndef add_task(scheduler, name, priority):\n    """Add a task with the given priority."""\n    # Your code here\n    pass\n\ndef run_next(scheduler):\n    """Run the highest-priority task. Return its name or None."""\n    # Your code here\n    pass\n\ndef get_pending(scheduler):\n    """Return list of pending task names in priority order."""\n    # Your code here\n    pass\n\ndef get_stats(scheduler):\n    """Return scheduler statistics."""\n    # Your code here\n    pass\n\n\n# Try it out:\ns = create_scheduler()\nadd_task(s, "Write docs", 3)\nadd_task(s, "Fix critical bug", 1)\nadd_task(s, "Code review", 2)\nadd_task(s, "Update deps", 4)\n\nprint(f"Pending: {get_pending(s)}")\nprint(f"Stats: {get_stats(s)}")\n\nprint(f"\\nRunning: {run_next(s)}")\nprint(f"Running: {run_next(s)}")\nprint(f"\\nPending: {get_pending(s)}")\nprint(f"Stats: {get_stats(s)}")\n',
    check: 's = create_scheduler()\nassert get_pending(s) == []\nassert run_next(s) is None\n\nadd_task(s, "low", 3)\nadd_task(s, "high", 1)\nadd_task(s, "mid", 2)\n\nassert get_pending(s) == ["high", "mid", "low"]\nassert get_stats(s) == {"pending": 3, "completed": 0, "total": 3}\n\nassert run_next(s) == "high"\nassert get_pending(s) == ["mid", "low"]\nassert get_stats(s) == {"pending": 2, "completed": 1, "total": 3}\n\nassert run_next(s) == "mid"\nassert run_next(s) == "low"\nassert run_next(s) is None\nassert get_stats(s)["completed"] == 3\nprint("All tests passed!")\n'
  },
  "4": {
    title: "Exercise 4 — Exponential Backoff Calculator",
    description: "Write a function backoff_delays(base=1, factor=2, max_delay=60, jitter=False, attempts=5)\nthat returns a list of delay values for exponential backoff.\n\nThe delay for attempt i (0-indexed) is: min(base * factor^i, max_delay)\n\nIf jitter=True, multiply each delay by a random float between 0.5 and 1.5.\nUse random.uniform(0.5, 1.5) for the jitter multiplier,\nthen cap at max_delay again.\n\nAlso write total_wait(delays) that returns the sum of all delays,\nrounded to 2 decimal places.\n\nExamples:\n  backoff_delays(base=1, factor=2, max_delay=60, jitter=False, attempts=5)\n  -> [1, 2, 4, 8, 16]\n\n  backoff_delays(base=1, factor=2, max_delay=10, jitter=False, attempts=5)\n  -> [1, 2, 4, 8, 10]  (capped at 10)\n\n  total_wait([1, 2, 4, 8, 16]) -> 31",
    code: 'import random\n\ndef backoff_delays(base=1, factor=2, max_delay=60, jitter=False, attempts=5):\n    """Calculate exponential backoff delays."""\n    # Your code here\n    pass\n\ndef total_wait(delays):\n    """Calculate total wait time, rounded to 2 decimals."""\n    # Your code here\n    pass\n\n\n# Try it out:\ndelays = backoff_delays(base=1, factor=2, max_delay=60, attempts=8)\nprint(f"No jitter: {delays}")\nprint(f"Total wait: {total_wait(delays)}s")\n\ndelays_capped = backoff_delays(base=1, factor=2, max_delay=10, attempts=8)\nprint(f"\\nCapped at 10: {delays_capped}")\nprint(f"Total wait: {total_wait(delays_capped)}s")\n\nrandom.seed(42)\ndelays_jitter = backoff_delays(base=1, factor=2, max_delay=60, jitter=True, attempts=5)\nprint(f"\\nWith jitter: {delays_jitter}")\nprint(f"Total wait: {total_wait(delays_jitter)}s")\n',
    check: 'd1 = backoff_delays(base=1, factor=2, max_delay=60, jitter=False, attempts=5)\nassert d1 == [1, 2, 4, 8, 16], f"Expected [1,2,4,8,16], got {d1}"\n\nd2 = backoff_delays(base=1, factor=2, max_delay=10, jitter=False, attempts=5)\nassert d2 == [1, 2, 4, 8, 10], f"Expected [1,2,4,8,10], got {d2}"\n\nd3 = backoff_delays(base=2, factor=3, max_delay=100, jitter=False, attempts=4)\nassert d3 == [2, 6, 18, 54], f"Expected [2,6,18,54], got {d3}"\n\nassert total_wait([1, 2, 4, 8, 16]) == 31\nassert total_wait([]) == 0\n\nd4 = backoff_delays(base=1, factor=2, max_delay=60, jitter=True, attempts=5)\nassert len(d4) == 5\nassert all(d <= 60 for d in d4), "Jittered delays should be capped"\nprint("All tests passed!")\n'
  },
  "5": {
    title: "Exercise 5 — Fault-Tolerant Processor",
    description: "Write a function process_batch(items, processor, fallback=None) that processes\na list of items through a processor function, handling failures gracefully.\n\nFor each item:\n  - Call processor(item)\n  - If it succeeds, record the result\n  - If it raises an exception, use fallback(item) if provided,\n    otherwise record None\n\nReturn a dict:\n  {\n    \"results\": [<processed values>],\n    \"succeeded\": <count>,\n    \"failed\": <count>,\n    \"errors\": [{\"index\": i, \"item\": item, \"error\": str(e)}, ...]\n  }\n\nAlso write make_safe_processor(func, validators=None) that wraps func\nwith optional pre-validation.\n  - validators is a list of functions that take an item and return True/False\n  - If any validator returns False, raise ValueError(\"validation failed\")\n  - Otherwise call func(item)\n\nExample:\n  def double(x): return x * 2\n  result = process_batch([1, \"bad\", 3], double)\n  # 1*2=2, \"bad\"*2=\"badbad\" (works), 3*2=6\n  # -> {\"results\": [2, \"badbad\", 6], \"succeeded\": 3, \"failed\": 0, \"errors\": []}",
    code: 'def process_batch(items, processor, fallback=None):\n    """Process items with error handling and fallback."""\n    # Your code here\n    pass\n\ndef make_safe_processor(func, validators=None):\n    """Wrap a function with optional validators."""\n    # Your code here\n    pass\n\n\n# Try it out:\ndef parse_int(x):\n    return int(x)\n\nresult = process_batch(["1", "2", "bad", "4", "nope"], parse_int)\nprint(f"Results: {result[\'results\']}")\nprint(f"Succeeded: {result[\'succeeded\']}, Failed: {result[\'failed\']}")\nfor e in result["errors"]:\n    print(f"  Error at index {e[\'index\']}: {e[\'error\']}")\n\n# With fallback\nresult2 = process_batch(\n    ["1", "bad", "3"],\n    parse_int,\n    fallback=lambda x: -1\n)\nprint(f"\\nWith fallback: {result2[\'results\']}")\n\n# With validators\nsafe = make_safe_processor(\n    lambda x: x * 2,\n    validators=[lambda x: isinstance(x, (int, float))]\n)\nresult3 = process_batch([1, "text", 3, None], safe)\nprint(f"\\nSafe processor: {result3[\'results\']}")\n',
    check: 'def boom(x):\n    if x < 0:\n        raise ValueError("negative!")\n    return x * 10\n\nr1 = process_batch([1, -1, 3], boom)\nassert r1["results"] == [10, None, 30], f"Got {r1[\'results\']}"\nassert r1["succeeded"] == 2\nassert r1["failed"] == 1\nassert len(r1["errors"]) == 1\nassert r1["errors"][0]["index"] == 1\n\nr2 = process_batch([1, -1, 3], boom, fallback=lambda x: 0)\nassert r2["results"] == [10, 0, 30]\nassert r2["failed"] == 1\n\nr3 = process_batch([], boom)\nassert r3["results"] == [] and r3["succeeded"] == 0\n\nsafe = make_safe_processor(\n    lambda x: x * 2,\n    validators=[lambda x: isinstance(x, int)]\n)\nr4 = process_batch([1, "bad", 3], safe)\nassert r4["results"] == [2, None, 6]\nassert r4["failed"] == 1\nprint("All tests passed!")\n'
  }
};

var params = new URLSearchParams(window.location.search);
var exNum = params.get('ex') || window.location.hash.replace('#exercise-', '') || '1';
var exercise = EXERCISES[exNum];

document.getElementById('exerciseTitle').textContent = exercise ? exercise.title : 'Not Found';
document.getElementById('description').textContent = exercise ? exercise.description : 'Exercise not found.';
document.title = exercise ? exercise.title + ' - Level 5 - Python in the Browser' : 'Not Found';

var exNums = Object.keys(EXERCISES);
var currentIdx = exNums.indexOf(exNum);
var prevLink = document.getElementById('prevLink');
var nextLink = document.getElementById('nextLink');
if (currentIdx > 0) { prevLink.href = 'level-5.html?ex=' + exNums[currentIdx - 1]; }
else { prevLink.style.visibility = 'hidden'; }
if (currentIdx < exNums.length - 1) { nextLink.href = 'level-5.html?ex=' + exNums[currentIdx + 1]; }
else { nextLink.style.visibility = 'hidden'; }

var cmEditor = CodeMirror.fromTextArea(document.getElementById('editor'), {
  mode: 'python', theme: 'dracula', lineNumbers: true,
  indentUnit: 4, tabSize: 4, indentWithTabs: false, lineWrapping: true,
  extraKeys: {
    'Tab': function(cm) { cm.replaceSelection('    ', 'end'); },
    'Ctrl-Enter': function() { runCode(); },
    'Cmd-Enter': function() { runCode(); }
  }
});
var originalCode = exercise ? exercise.code : '';

var storageKey = 'learn-python-l5-ex-' + exNum;
var savedCode = localStorage.getItem(storageKey);
if (savedCode !== null) { cmEditor.setValue(savedCode); }
else if (exercise) { cmEditor.setValue(exercise.code); }

var saveTimer = null;
cmEditor.on('change', function() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(function() {
    localStorage.setItem(storageKey, cmEditor.getValue());
  }, 500);
});

var outputEl = document.getElementById('output');
var statusLabel = document.getElementById('statusLabel');
var runBtn = document.getElementById('runBtn');
var checkBtn = document.getElementById('checkBtn');

function appendOutput(text, className) {
  var span = document.createElement('span');
  if (className) span.className = className;
  span.textContent = text;
  outputEl.appendChild(span);
  outputEl.scrollTop = outputEl.scrollHeight;
}

function clearOutput() {
  while (outputEl.firstChild) { outputEl.removeChild(outputEl.firstChild); }
}

var pyodideInstance = null;

async function initPyodide() {
  try {
    pyodideInstance = await loadPyodide();
    runBtn.disabled = false;
    checkBtn.disabled = false;
    document.getElementById('loading').classList.add('hidden');
  } catch (e) {
    document.getElementById('loading').querySelector('p').textContent =
      'Failed to load Python runtime. Please refresh.';
  }
}

async function executePython(code, label) {
  if (!pyodideInstance) return;
  clearOutput();
  statusLabel.textContent = label || 'Running...';
  statusLabel.style.color = '';
  runBtn.disabled = true;
  checkBtn.disabled = true;

  try {
    pyodideInstance.runPython(
      'import sys\nfrom io import StringIO\n' +
      'sys.stdout = StringIO()\nsys.stderr = StringIO()\n'
    );

    var needsInput = code.indexOf('input(') !== -1;
    if (needsInput) {
      pyodideInstance.globals.set('_js_prompt', function(promptText) {
        return prompt(promptText || 'Enter value:') || '';
      });
      pyodideInstance.runPython(
        'import builtins\n_orig_input = builtins.input\n' +
        'def _patched_input(prompt_text=""):\n' +
        '    sys.stdout.write(str(prompt_text))\n' +
        '    val = _js_prompt(str(prompt_text))\n' +
        '    if hasattr(val, "to_py"): val = str(val)\n' +
        '    sys.stdout.write(str(val) + "\\n")\n' +
        '    return str(val)\n' +
        'builtins.input = _patched_input\n'
      );
    }

    pyodideInstance.runPython(code);

    if (needsInput) {
      pyodideInstance.runPython('builtins.input = _orig_input\n');
    }

    var stdout = pyodideInstance.runPython('sys.stdout.getvalue()');
    var stderr = pyodideInstance.runPython('sys.stderr.getvalue()');
    if (stdout) appendOutput(stdout, '');
    if (stderr) appendOutput(stderr, 'error');
    statusLabel.textContent = 'Done';
    return true;

  } catch (e) {
    try {
      var partial = pyodideInstance.runPython('sys.stdout.getvalue()');
      if (partial) appendOutput(partial, '');
    } catch (ignored) {}

    var msg = e.message || String(e);
    var tbIdx = msg.indexOf('Traceback');
    appendOutput(tbIdx !== -1 ? msg.substring(tbIdx) : msg, 'error');
    statusLabel.textContent = 'Error';
    return false;

  } finally {
    try {
      pyodideInstance.runPython('sys.stdout = sys.__stdout__\nsys.stderr = sys.__stderr__\n');
    } catch (ignored) {}
    runBtn.disabled = false;
    checkBtn.disabled = false;
  }
}

async function runCode() {
  await executePython(cmEditor.getValue(), 'Running...');
}

async function checkCode() {
  if (!exercise || !exercise.check) return;
  var userCode = cmEditor.getValue();
  var fullCode = userCode + '\n' + exercise.check;
  var success = await executePython(fullCode, 'Checking...');
  if (success) {
    var output = outputEl.textContent || '';
    if (output.indexOf('All tests passed') !== -1) {
      statusLabel.textContent = 'PASSED';
      statusLabel.style.color = 'var(--green)';
    }
  }
}

runBtn.addEventListener('click', runCode);
checkBtn.addEventListener('click', checkCode);
document.getElementById('resetBtn').addEventListener('click', function() {
  cmEditor.setValue(originalCode);
  localStorage.removeItem(storageKey);
});
document.getElementById('clearBtn').addEventListener('click', clearOutput);

var s = document.createElement('script');
s.src = 'https://cdn.jsdelivr.net/pyodide/v0.27.4/full/pyodide.js';
s.onload = initPyodide;
document.head.appendChild(s);
</script>
</body>
</html>
